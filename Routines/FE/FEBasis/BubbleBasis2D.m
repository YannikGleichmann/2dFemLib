function basis = BubbleBasis2D(r)
% this functions computes the FE Basis with bubble function of order r
% 
%--------------------------------------------------------------------------
% Reference:
% [1] Higher Order Mass Lumped Finite Elements For The Wave Equation
%       - W. A. Mulder 
% [2] Higher Order Triangular Finite Elements With Muss Lumping For
%     The Wave Equation - G. Cohen et.al.
% 
%--------------------------------------------------------------------------
% Usage:
%           basis = BubbleBasis2D(r)
% Input:
% * r       - order of FE Basis
% 
% Output:
% * basis   - function handle that can be evaluated at points (x,y)
%             Usage:
%                   basis = [N]                      pure basis function
%                   basis = [N,Nx,Ny]                up till 1st derivative
%                   basis = [N,Nx,Ny,Nxx,Nyy,Nxy]    up till 2nd derivative
% 
%--------------------------------------------------------------------------
% Author: Yannik Gleichmann
% Date:   13.06.2020

switch r
case 1
  basis = @P1b;
case 2
  basis = @P2b;
case 3
  basis = @P3b;
 otherwise
    error('Not implemented');
end

%% P1b
function [N,Nx,Ny,Nxx,Nyy,Nxy] = P1b(x,y)
  N = {1-x-y, x, y};
  if nargout<=1; return; end
  Nx = {-1+0*x, 1+0*x,   0*x};
  Ny = {-1+0*x,   0*x, 1+0*x};
  if nargout<=3; return; end
  Nxx = {0*x, 0*x, 0*x};
  Nyy = {0*x, 0*x, 0*x};
  Nxy = {0*x, 0*x, 0*x};
end

%% P2b
function [N,Nx,Ny,Nxx,Nyy,Nxy] = P2b(x,y)
  N = {2*(1-x-y).*(1/2-x-y)+3*x.*y.*(1-x-y), ...
       2*x.*(x-1/2)+3*x.*y.*(1-x-y), ...
       2*y.*(y-1/2)+3*x.*y.*(1-x-y), ...
       4*x.*(1-x-y)-12*x.*y.*(1-x-y), ...
       4*x.*y-12*x.*y.*(1-x-y), ...
       4*y.*(1-x-y)-12*x.*y.*(1-x-y), ...
       27*x.*y.*(1-x-y) ...
       };
  if nargout<=1; return; end
  Nx = {4*y+4*x-3*y.*(y+x-1)-3*y.*x-3, ...
        4*x-3*y.*(y+x-1)-3*y.*x-1, ...
        3*y.*(1-y-x)-3*y.*x, ...
        12*y.*(y+x-1)-8*x-4*y+12*y.*x+4, ...
        4*y+12*y.*(y+x-1)+12*y.*x, ...
        12*y.*(y+x-1)-4*y+12*y.*x, ...
        -27*y.*(y+x-1)-27*y.*x, ...
        };
  Ny = {4*y+4*x-3*x.*(y+x-1)-3*y.*x-3, ...
        -3*x.*(y+x-1)-3*y.*x, ...
        4*y-3*x.*(y+x-1)-3*y.*x-1, ...
        12*x.*(y+x-1)-4*x+12*y.*x, ...
        4*x+12*x.*(y+x-1)+12*y.*x, ...
        12*x.*(y+x-1)-4*x-8*y+12*y.*x+4, ...
        -27*x.*(y+x-1)-27*y.*x ...
        };
  if nargout<=3; return; end
  Nxx = {4-6*y, 4-6*y, -6*y, ...
         -8+24*y, 24*y, 24*y, ...
         -54*y ...
         };
  Nyy = {4-6*x,-6*x,4-6*x, ...
         24*x,24*x,-8+24*x, ...
         -54*x ...
         };
  Nxy = {7-6*x-6*y, 3-6*x-6*y, 3-6*x-6*y, ...
         -16+24*x+24*y, -8+24*x+24*y, -16+24*x+24*y, ...
         27-54*x-54*y ...
         };
end

function [N,Nx,Ny,Nxx,Nyy,Nxy]  = P3b(x,y)
  N = {...
       x.*(-5.822875655532295)-y.*5.822875655532295+x.^2.*y.^2.*3.004051835490426e1+x.*y.*2.948888614404902e1-x.*y.^2.*3.968626966596885e1-x.^2.*y.*3.968626966596885e1+x.*y.^3.*1.502025917745213e1+x.^3.*y.*1.502025917745213e1+x.^2.*9.645751311064591-x.^3.*4.822875655532295+y.^2.*9.645751311064591-y.^3.*4.822875655532295+1.0,...
       x.*1.0-x.^2.*y.^2.*1.502025917745213e1-x.*y.*4.822875655532296+x.*y.^2.*4.822875655532296+x.^2.*y.*1.984313483298443e1-x.^3.*y.*1.502025917745213e1-x.^2.*4.822875655532295+x.^3.*4.822875655532295,...
       y.*1.0-x.^2.*y.^2.*1.502025917745213e1-x.*y.*4.822875655532296+x.*y.^2.*1.984313483298443e1+x.^2.*y.*4.822875655532296-x.*y.^3.*1.502025917745213e1-y.^2.*4.822875655532295+y.^3.*4.822875655532295,...
       x.*8.249409654099186-x.^2.*y.^2.*1.04337371802352e2-x.*y.*5.799319367933725e1+x.*y.^2.*9.776953142978006e1+x.^2.*y.*1.177313520757142e2-x.*y.^3.*4.802574740454199e1-x.^3.*y.*5.631162439781005e1-x.^2.*1.992535330676526e1+x.^3.*1.167594365266608e1,...
       x.*(-3.42653399856689)+x.^2.*y.^2.*6.459750139107812e1+x.*y.*2.167031802380495e1-x.*y.^2.*2.652966101850613e1-x.^2.*y.*8.62313520757142e1+x.*y.^3.*8.285876993268061+x.^3.*y.*5.631162439781006e1+x.^2.*1.510247765123297e1-x.^3.*1.167594365266608e1,...
       x.^2.*y.^2.*3.973987041127393e1+x.*y.*6.531373033403114-x.*y.^2.*1.672030038701945-x.^2.*y.*4.630771078384592e1-x.*y.^3.*8.285876993268059+x.^3.*y.*4.802574740454199e1,...
       x.^2.*y.^2.*3.973987041127393e1+x.*y.*6.531373033403114-x.*y.^2.*4.630771078384592e1-x.^2.*y.*1.672030038701945+x.*y.^3.*4.802574740454199e1-x.^3.*y.*8.285876993268059,...
       y.*(-3.42653399856689)+x.^2.*y.^2.*6.459750139107812e1+x.*y.*2.167031802380495e1-x.*y.^2.*8.62313520757142e1-x.^2.*y.*2.652966101850613e1+x.*y.^3.*5.631162439781006e1+x.^3.*y.*8.285876993268061+y.^2.*1.510247765123297e1-y.^3.*1.167594365266608e1,...
       y.*8.249409654099186-x.^2.*y.^2.*1.04337371802352e2-x.*y.*5.799319367933725e1+x.*y.^2.*1.177313520757142e2+x.^2.*y.*9.776953142978006e1-x.*y.^3.*5.631162439781005e1-x.^3.*y.*4.802574740454199e1-y.^2.*1.992535330676526e1+y.^3.*1.167594365266608e1,...
       x.^2.*y.^2.*2.102836284843299e2+x.*y.*8.334116629853461e1-x.*y.^2.*1.884829805406996e2-x.^2.*y.*1.884829805406996e2+x.*y.^3.*1.051418142421649e2+x.^3.*y.*1.051418142421649e2,...
       x.^2.*y.^2.*(-1.051418142421649e2)-x.*y.*2.180064794363033e1+x.*y.^2.*2.180064794363033e1+x.^2.*y.*1.269424621857953e2-x.^3.*y.*1.051418142421649e2,...
       x.^2.*y.^2.*(-1.051418142421649e2)-x.*y.*2.180064794363033e1+x.*y.^2.*1.269424621857953e2+x.^2.*y.*2.180064794363033e1-x.*y.^3.*1.051418142421649e2,...
       };
  if nargout<=1; return; end
  Nx = {...
        x.*1.929150262212918e1+y.*2.948888614404902e1-x.*y.*7.93725393319377e1+x.*y.^2.*6.008103670980852e1+x.^2.*y.*4.506077753235639e1-x.^2.*1.446862696659689e1-y.^2.*3.968626966596885e1+y.^3.*1.502025917745213e1-5.822875655532295,...
        x.*(-9.645751311064591)-y.*4.822875655532296+x.*y.*3.968626966596885e1-x.*y.^2.*3.004051835490426e1-x.^2.*y.*4.506077753235639e1+x.^2.*1.446862696659689e1+y.^2.*4.822875655532296+1.0,...
        y.*(-4.822875655532296)+x.*y.*9.645751311064591-x.*y.^2.*3.004051835490426e1+y.^2.*1.984313483298443e1-y.^3.*1.502025917745213e1,...
        x.*(-3.985070661353052e1)-y.*5.799319367933725e1+x.*y.*2.354627041514284e2-x.*y.^2.*2.086747436047041e2-x.^2.*y.*1.689348731934302e2+x.^2.*3.502783095799823e1+y.^2.*9.776953142978006e1-y.^3.*4.802574740454199e1+8.249409654099186,...
        x.*3.020495530246593e1+y.*2.167031802380495e1-x.*y.*1.724627041514284e2+x.*y.^2.*1.291950027821562e2+x.^2.*y.*1.689348731934302e2-x.^2.*3.502783095799823e1-y.^2.*2.652966101850613e1+y.^3.*8.285876993268061-3.42653399856689,...
        y.*6.531373033403114-x.*y.*9.261542156769185e1+x.*y.^2.*7.947974082254787e1+x.^2.*y.*1.44077242213626e2-y.^2.*1.672030038701945-y.^3.*8.285876993268059,...
        y.*6.531373033403114-x.*y.*3.34406007740389+x.*y.^2.*7.947974082254787e1-x.^2.*y.*2.485763097980418e1-y.^2.*4.630771078384592e1+y.^3.*4.802574740454199e1,...
        y.*2.167031802380495e1-x.*y.*5.305932203701225e1+x.*y.^2.*1.291950027821562e2+x.^2.*y.*2.485763097980418e1-y.^2.*8.62313520757142e1+y.^3.*5.631162439781006e1,...
        y.*(-5.799319367933725e1)+x.*y.*1.955390628595601e2-x.*y.^2.*2.086747436047041e2-x.^2.*y.*1.44077242213626e2+y.^2.*1.177313520757142e2-y.^3.*5.631162439781005e1,...
        y.*8.334116629853461e1-x.*y.*3.769659610813991e2+x.*y.^2.*4.205672569686598e2+x.^2.*y.*3.154254427264948e2-y.^2.*1.884829805406996e2+y.^3.*1.051418142421649e2,...
        y.*(-2.180064794363033e1)+x.*y.*2.538849243715906e2-x.*y.^2.*2.102836284843299e2-x.^2.*y.*3.154254427264948e2+y.^2.*2.180064794363033e1,...
        y.*(-2.180064794363033e1)+x.*y.*4.360129588726067e1-x.*y.^2.*2.102836284843299e2+y.^2.*1.269424621857953e2-y.^3.*1.051418142421649e2,...
        };
  Ny = {...
        x.*2.948888614404902e1+y.*1.929150262212918e1-x.*y.*7.93725393319377e1+x.*y.^2.*4.506077753235639e1+x.^2.*y.*6.008103670980852e1-x.^2.*3.968626966596885e1+x.^3.*1.502025917745213e1-y.^2.*1.446862696659689e1-5.822875655532295,...
        x.*(-4.822875655532296)+x.*y.*9.645751311064591-x.^2.*y.*3.004051835490426e1+x.^2.*1.984313483298443e1-x.^3.*1.502025917745213e1,...
        x.*(-4.822875655532296)-y.*9.645751311064591+x.*y.*3.968626966596885e1-x.*y.^2.*4.506077753235639e1-x.^2.*y.*3.004051835490426e1+x.^2.*4.822875655532296+y.^2.*1.446862696659689e1+1.0,...
        x.*(-5.799319367933725e1)+x.*y.*1.955390628595601e2-x.*y.^2.*1.44077242213626e2-x.^2.*y.*2.086747436047041e2+x.^2.*1.177313520757142e2-x.^3.*5.631162439781005e1,...
        x.*2.167031802380495e1-x.*y.*5.305932203701225e1+x.*y.^2.*2.485763097980418e1+x.^2.*y.*1.291950027821562e2-x.^2.*8.62313520757142e1+x.^3.*5.631162439781006e1,...
        x.*6.531373033403114-x.*y.*3.34406007740389-x.*y.^2.*2.485763097980418e1+x.^2.*y.*7.947974082254787e1-x.^2.*4.630771078384592e1+x.^3.*4.802574740454199e1,...
        x.*6.531373033403114-x.*y.*9.261542156769185e1+x.*y.^2.*1.44077242213626e2+x.^2.*y.*7.947974082254787e1-x.^2.*1.672030038701945-x.^3.*8.285876993268059,...
        x.*2.167031802380495e1+y.*3.020495530246593e1-x.*y.*1.724627041514284e2+x.*y.^2.*1.689348731934302e2+x.^2.*y.*1.291950027821562e2-x.^2.*2.652966101850613e1+x.^3.*8.285876993268061-y.^2.*3.502783095799823e1-3.42653399856689,...
        x.*(-5.799319367933725e1)-y.*3.985070661353052e1+x.*y.*2.354627041514284e2-x.*y.^2.*1.689348731934302e2-x.^2.*y.*2.086747436047041e2+x.^2.*9.776953142978006e1-x.^3.*4.802574740454199e1+y.^2.*3.502783095799823e1+8.249409654099186,...
        x.*8.334116629853461e1-x.*y.*3.769659610813991e2+x.*y.^2.*3.154254427264948e2+x.^2.*y.*4.205672569686598e2-x.^2.*1.884829805406996e2+x.^3.*1.051418142421649e2,...
        x.*(-2.180064794363033e1)+x.*y.*4.360129588726067e1-x.^2.*y.*2.102836284843299e2+x.^2.*1.269424621857953e2-x.^3.*1.051418142421649e2,...
        x.*(-2.180064794363033e1)+x.*y.*2.538849243715906e2-x.*y.^2.*3.154254427264948e2-x.^2.*y.*2.102836284843299e2+x.^2.*2.180064794363033e1,...
        };
  if nargout<=3; return; end
  Nxx = {...
         x.*(-2.893725393319377e1)-y.*7.93725393319377e1+x.*y.*9.012155506471279e1+y.^2.*6.008103670980852e1+1.929150262212918e1,...
         x.*2.893725393319377e1+y.*3.968626966596885e1-x.*y.*9.012155506471279e1-y.^2.*3.004051835490426e1-9.645751311064591,...
         y.*9.645751311064591-y.^2.*3.004051835490426e1,...
         x.*7.005566191599645e1+y.*2.354627041514284e2-x.*y.*3.378697463868603e2-y.^2.*2.086747436047041e2-3.985070661353052e1,...
         x.*(-7.005566191599645e1)-y.*1.724627041514284e2+x.*y.*3.378697463868604e2+y.^2.*1.291950027821562e2+3.020495530246593e1,...
         y.*(-9.261542156769185e1)+x.*y.*2.88154484427252e2+y.^2.*7.947974082254787e1,...
         y.*(-3.34406007740389)-x.*y.*4.971526195960836e1+y.^2.*7.947974082254787e1,...
         y.*(-5.305932203701225e1)+x.*y.*4.971526195960837e1+y.^2.*1.291950027821562e2,...
         y.*1.955390628595601e2-x.*y.*2.88154484427252e2-y.^2.*2.086747436047041e2,...
         y.*(-3.769659610813991e2)+x.*y.*6.308508854529897e2+y.^2.*4.205672569686598e2,...
         y.*2.538849243715906e2-x.*y.*6.308508854529897e2-y.^2.*2.102836284843299e2,...
         y.*4.360129588726067e1-y.^2.*2.102836284843299e2,...
         };
  Nxy = {...
         x.*(-7.93725393319377e1)-y.*7.93725393319377e1+x.*y.*1.20162073419617e2+x.^2.*4.506077753235639e1+y.^2.*4.506077753235639e1+2.948888614404902e1,...
         x.*3.968626966596885e1+y.*9.645751311064591-x.*y.*6.008103670980852e1-x.^2.*4.506077753235639e1-4.822875655532296,...
         x.*9.645751311064591+y.*3.968626966596885e1-x.*y.*6.008103670980852e1-y.^2.*4.506077753235639e1-4.822875655532296,...
         x.*2.354627041514284e2+y.*1.955390628595601e2-x.*y.*4.173494872094082e2-x.^2.*1.689348731934302e2-y.^2.*1.44077242213626e2-5.799319367933725e1,...
         x.*(-1.724627041514284e2)-y.*5.305932203701225e1+x.*y.*2.583900055643125e2+x.^2.*1.689348731934302e2+y.^2.*2.485763097980418e1+2.167031802380495e1,...
         x.*(-9.261542156769185e1)-y.*3.34406007740389+x.*y.*1.589594816450957e2+x.^2.*1.44077242213626e2-y.^2.*2.485763097980418e1+6.531373033403114,...
         x.*(-3.34406007740389)-y.*9.261542156769185e1+x.*y.*1.589594816450957e2-x.^2.*2.485763097980418e1+y.^2.*1.44077242213626e2+6.531373033403114,...
         x.*(-5.305932203701225e1)-y.*1.724627041514284e2+x.*y.*2.583900055643125e2+x.^2.*2.485763097980418e1+y.^2.*1.689348731934302e2+2.167031802380495e1,...
         x.*1.955390628595601e2+y.*2.354627041514284e2-x.*y.*4.173494872094082e2-x.^2.*1.44077242213626e2-y.^2.*1.689348731934302e2-5.799319367933725e1,...
         x.*(-3.769659610813991e2)-y.*3.769659610813991e2+x.*y.*8.411345139373196e2+x.^2.*3.154254427264948e2+y.^2.*3.154254427264948e2+8.334116629853461e1,...
         x.*2.538849243715906e2+y.*4.360129588726067e1-x.*y.*4.205672569686598e2-x.^2.*3.154254427264948e2-2.180064794363033e1,...
         x.*4.360129588726067e1+y.*2.538849243715906e2-x.*y.*4.205672569686598e2-y.^2.*3.154254427264948e2-2.180064794363033e1,...
         };
  Nyy = {...
         x.*(-7.93725393319377e1)-y.*2.893725393319377e1+x.*y.*9.012155506471279e1+x.^2.*6.008103670980852e1+1.929150262212918e1,...
         x.*9.645751311064591-x.^2.*3.004051835490426e1,...
         x.*3.968626966596885e1+y.*2.893725393319377e1-x.*y.*9.012155506471279e1-x.^2.*3.004051835490426e1-9.645751311064591,...
         x.*1.955390628595601e2-x.*y.*2.88154484427252e2-x.^2.*2.086747436047041e2,...
         x.*(-5.305932203701225e1)+x.*y.*4.971526195960837e1+x.^2.*1.291950027821562e2,...
         x.*(-3.34406007740389)-x.*y.*4.971526195960836e1+x.^2.*7.947974082254787e1,...
         x.*(-9.261542156769185e1)+x.*y.*2.88154484427252e2+x.^2.*7.947974082254787e1,...
         x.*(-1.724627041514284e2)-y.*7.005566191599645e1+x.*y.*3.378697463868604e2+x.^2.*1.291950027821562e2+3.020495530246593e1,...
         x.*2.354627041514284e2+y.*7.005566191599645e1-x.*y.*3.378697463868603e2-x.^2.*2.086747436047041e2-3.985070661353052e1,...
         x.*(-3.769659610813991e2)+x.*y.*6.308508854529897e2+x.^2.*4.205672569686598e2,...
         x.*4.360129588726067e1-x.^2.*2.102836284843299e2,...
         x.*2.538849243715906e2-x.*y.*6.308508854529897e2-x.^2.*2.102836284843299e2,...
         };
end

end